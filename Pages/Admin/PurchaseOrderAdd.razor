@page "/admin/purchase-orders/add"
@attribute [Authorize(Roles = "Admin, Purchasing")]
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject PurchaseOrderService PurchaseOrderSvc
@inject ToastService ToastSvc

<h3>Tạo Đơn nhập hàng mới</h3>

<EditForm Model="@newPurchaseOrder" OnValidSubmit="HandleCreatePurchaseOrder">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Thông tin chung</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label>Chọn Nhà cung cấp</label>
                    <InputSelect @bind-Value="newPurchaseOrder.SupplierId" class="form-select">
                        <option value="0">-- Vui lòng chọn --</option>
                        @if (suppliers != null)
                        {
                            @foreach (var supplier in suppliers)
                            {
                                <option value="@supplier.Id">@supplier.Name</option>
                            }
                        }
                    </InputSelect>
                </div>
                <div class="col-md-6 mb-3">
                    <label>Ngày giao hàng dự kiến</label>
                    <InputDate @bind-Value="newPurchaseOrder.ExpectedDeliveryDate" class="form-control" />
                </div>
            </div>

            <hr />

            <h5 class="card-title">Thêm sản phẩm vào đơn</h5>
            <div class="row align-items-end">
                <div class="col-md-5">
                    <label>Sản phẩm</label>
                    <InputSelect @bind-Value="newItem.ProductId" class="form-select">
                        <option value="0">-- Chọn sản phẩm --</option>
                         @if (products != null)
                        {
                            @foreach (var product in products)
                            {
                                <option value="@product.Id">@product.Name</option>
                            }
                        }
                    </InputSelect>
                </div>
                <div class="col-md-3">
                    <label>Số lượng</label>
                    <InputNumber @bind-Value="newItem.Quantity" class="form-control" />
                </div>
                <div class="col-md-3">
                    <label>Đơn giá nhập</label>
                    <InputNumber @bind-Value="newItem.UnitPrice" class="form-control" />
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-success" @onclick="AddItem">Thêm</button>
                </div>
            </div>

            <h5 class="card-title mt-4">Các sản phẩm trong đơn</h5>
            <table class="table">
                <tbody>
                    @foreach (var item in newPurchaseOrder.Items)
                    {
                        <tr>
                            <td>@(products?.FirstOrDefault(p => p.Id == item.ProductId)?.Name)</td>
                            <td>Số lượng: @item.Quantity</td>
                            <td>Đơn giá: @item.UnitPrice.ToString("n0")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        <div class="card-footer">
            <button type="submit" class="btn btn-primary">Tạo Đơn nhập hàng</button>
            <a href="/admin/purchase-orders" class="btn btn-secondary">Hủy</a>
        </div>
    </div>
</EditForm>


@code {
    private PurchaseOrder newPurchaseOrder = new();
    private PurchaseOrderItem newItem = new();
    private List<Supplier>? suppliers;
    private List<Product>? products;

    protected override async Task OnInitializedAsync()
    {
        suppliers = await DbContext.Suppliers.ToListAsync();
        products = await DbContext.Products.ToListAsync();
    }

    private void AddItem()
    {
        // chỉ thêm nếu đã chọn sản phẩm & số lượng hợp lệ
        if (newItem.ProductId > 0 && newItem.Quantity > 0)
        {
            // clone item để tránh reuse cùng object
            var itemToAdd = new PurchaseOrderItem
            {
                ProductId = newItem.ProductId,
                Quantity = newItem.Quantity,
                UnitPrice = newItem.UnitPrice,
                // đảm bảo ReceivedQuantity mặc định bằng Quantity
                ReceivedQuantity = newItem.Quantity
            };

            newPurchaseOrder.Items.Add(itemToAdd);

            // reset form item
            newItem = new PurchaseOrderItem();
        }
        else
        {
            ToastSvc.ShowToast("Vui lòng chọn sản phẩm và nhập số lượng lớn hơn 0.", ToastLevel.Warning);
        }
    }

    private async Task HandleCreatePurchaseOrder()
    {
        // 1) Kiểm tra đã chọn nhà cung cấp
        if (newPurchaseOrder.SupplierId <= 0)
        {
            ToastSvc.ShowToast("Vui lòng chọn Nhà cung cấp trước khi tạo đơn.", ToastLevel.Warning);
            return;
        }

        // 2) Kiểm tra ít nhất 1 sản phẩm
        if (newPurchaseOrder.Items == null || !newPurchaseOrder.Items.Any())
        {
            ToastSvc.ShowToast("Vui lòng thêm ít nhất 1 sản phẩm vào phiếu.", ToastLevel.Warning);
            return;
        }

        // 3) Đảm bảo ReceivedQuantity cho mọi item
        foreach (var it in newPurchaseOrder.Items)
        {
            if (it.ReceivedQuantity <= 0)
                it.ReceivedQuantity = it.Quantity;
        }

        try
        {
            await PurchaseOrderSvc.CreatePurchaseOrderAsync(newPurchaseOrder);
            ToastSvc.ShowToast("Đã tạo Đơn nhập hàng thành công.", ToastLevel.Success);
            Navigation.NavigateTo("/admin/purchase-orders");
        }
        catch (Exception ex)
        {
            // hiển thị lỗi cụ thể
            ToastSvc.ShowToast($"Lỗi khi tạo đơn: {ex.Message}", ToastLevel.Error);
        }
    }
}
