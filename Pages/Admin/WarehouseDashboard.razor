@page "/admin/warehouse"
@page "/admin/warehouse/page/{OrderPage:int}/{PoPage:int}"
@attribute [Authorize(Roles = "Admin, Warehouse")]
@using Microsoft.EntityFrameworkCore
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation

<h3>Bảng điều khiển Kho</h3>

<div class="row">
    @* Cột 1: Đơn hàng cần xử lý để giao cho khách *@
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <span class="oi oi-box"></span> Đơn hàng cần xử lý (Xuất kho)
            </div>
            <div class="card-body">
                @if (ordersToFulfill == null)
                {
                    <LoadingSpinner />
                }
                else if (!ordersToFulfill.Any())
                {
                    <div class="alert alert-success mt-3">Không có đơn hàng nào cần xử lý.</div>
                }
                else
                {
                    <ul class="list-group">
                        @foreach (var order in ordersToFulfill)
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Đơn hàng #@order.Id - @order.CustomerName
                                <a href="@($"/admin/orders/{order.Id}")" class="btn btn-sm btn-info">Chuẩn bị hàng</a>
                            </li>
                        }
                    </ul>

                    <!-- Orders pagination -->
                    @if (orderTotalPages > 1)
                    {
                        <nav class="mt-3" aria-label="Orders page navigation">
                            <ul class="pagination justify-content-center">
                                <li class="page-item @(orderCurrentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="@($"/admin/warehouse/page/{Math.Max(orderCurrentPage - 1, 1)}/{poCurrentPage}")">Trước</a>
                                </li>

                                @for (int i = 1; i <= orderTotalPages; i++)
                                {
                                    var pageNum = i;
                                    <li class="page-item @(orderCurrentPage == pageNum ? "active" : "")">
                                        <a class="page-link" href="@($"/admin/warehouse/page/{pageNum}/{poCurrentPage}")">@pageNum</a>
                                    </li>
                                }

                                <li class="page-item @(orderCurrentPage == orderTotalPages ? "disabled" : "")">
                                    <a class="page-link" href="@($"/admin/warehouse/page/{Math.Min(orderCurrentPage + 1, orderTotalPages)}/{poCurrentPage}")">Sau</a>
                                </li>
                            </ul>
                        </nav>
                    }
                }
            </div>
        </div>
    </div>

    @* Cột 2: Đơn nhập hàng đang chờ nhận *@
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <span class="oi oi-clipboard"></span> Đơn nhập hàng đang chờ (Nhập kho)
            </div>
            <div class="card-body">
                @if (purchaseOrdersToReceive == null)
                {
                    <LoadingSpinner />
                }
                else if (!purchaseOrdersToReceive.Any())
                {
                     <div class="alert alert-info mt-3">Không có đơn nhập hàng nào đang chờ.</div>
                }
                else
                {
                    <ul class="list-group">
                        @foreach (var po in purchaseOrdersToReceive)
                        {
                             <li class="list-group-item d-flex justify-content-between align-items-center">
                                Phiếu nhập @po.PurchaseOrderNumber - @po.Supplier?.Name
                                <a href="@($"/admin/purchase-orders/{po.Id}")" class="btn btn-sm btn-secondary">Xem/Nhận hàng</a>
                            </li>
                        }
                    </ul>

                    <!-- Purchase Orders pagination -->
                    @if (poTotalPages > 1)
                    {
                        <nav class="mt-3" aria-label="PO page navigation">
                            <ul class="pagination justify-content-center">
                                <li class="page-item @(poCurrentPage == 1 ? "disabled" : "")">
                                    <a class="page-link" href="@($"/admin/warehouse/page/{orderCurrentPage}/{Math.Max(poCurrentPage - 1, 1)}")">Trước</a>
                                </li>

                                @for (int i = 1; i <= poTotalPages; i++)
                                {
                                    var pageNum = i;
                                    <li class="page-item @(poCurrentPage == pageNum ? "active" : "")">
                                        <a class="page-link" href="@($"/admin/warehouse/page/{orderCurrentPage}/{pageNum}")">@pageNum</a>
                                    </li>
                                }

                                <li class="page-item @(poCurrentPage == poTotalPages ? "disabled" : "")">
                                    <a class="page-link" href="@($"/admin/warehouse/page/{orderCurrentPage}/{Math.Min(poCurrentPage + 1, poTotalPages)}")">Sau</a>
                                </li>
                            </ul>
                        </nav>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    // Route parameters (Product.razor style but 2 params: OrderPage, PoPage)
    [Parameter] public int OrderPage { get; set; } = 1;
    [Parameter] public int PoPage { get; set; } = 1;

    // Data (paged)
    private List<Order>? ordersToFulfill;
    private List<PurchaseOrder>? purchaseOrdersToReceive;

    // Pagination state for orders
    private int orderCurrentPage = 1;
    private int orderPageSize = 5;
    private int orderTotalPages = 1;
    private int orderTotalItems = 0;

    // Pagination state for purchase orders
    private int poCurrentPage = 1;
    private int poPageSize = 5;
    private int poTotalPages = 1;
    private int poTotalItems = 0;

    protected override async Task OnParametersSetAsync()
    {
        // set current pages from route params
        orderCurrentPage = OrderPage > 0 ? OrderPage : 1;
        poCurrentPage = PoPage > 0 ? PoPage : 1;

        await LoadOrdersPage(orderCurrentPage);
        await LoadPurchaseOrdersPage(poCurrentPage);
    }

    private async Task LoadOrdersPage(int page)
    {
        // safe: create new DbContext for this operation
        await using var db = await DbFactory.CreateDbContextAsync();

        var statusesForWarehouse = new[]
        {
            "Đã thanh toán",
            "Sẵn sàng giao hàng",
            "Chờ thanh toán",
            "Chờ xác nhận"
        };

        IQueryable<Order> baseQ = db.Orders
            .AsNoTracking()
            .Where(o => statusesForWarehouse.Contains(o.Status));

        orderTotalItems = await baseQ.CountAsync();
        orderTotalPages = Math.Max(1, (int)Math.Ceiling((double)orderTotalItems / orderPageSize));
        orderCurrentPage = Math.Clamp(page, 1, orderTotalPages);

        ordersToFulfill = await baseQ
            .OrderBy(o => o.OrderDate)
            .Skip((orderCurrentPage - 1) * orderPageSize)
            .Take(orderPageSize)
            .ToListAsync();
    }

    private async Task LoadPurchaseOrdersPage(int page)
    {
        // safe: create new DbContext for this operation
        await using var db = await DbFactory.CreateDbContextAsync();

        IQueryable<PurchaseOrder> baseQ = db.PurchaseOrders
            .AsNoTracking()
            .Include(po => po.Supplier)
            .Where(po => po.Status == "Đã đặt hàng");

        poTotalItems = await baseQ.CountAsync();
        poTotalPages = Math.Max(1, (int)Math.Ceiling((double)poTotalItems / poPageSize));
        poCurrentPage = Math.Clamp(page, 1, poTotalPages);

        purchaseOrdersToReceive = await baseQ
            .OrderBy(po => po.OrderDate)
            .Skip((poCurrentPage - 1) * poPageSize)
            .Take(poPageSize)
            .ToListAsync();
    }

    // Optional programmatic navigation helpers (not strictly necessary; anchors already navigate)
    private void ChangeOrderPage(int page)
    {
        page = Math.Clamp(page, 1, orderTotalPages);
        Navigation.NavigateTo($"/admin/warehouse/page/{page}/{poCurrentPage}");
    }

    private void ChangePoPage(int page)
    {
        page = Math.Clamp(page, 1, poTotalPages);
        Navigation.NavigateTo($"/admin/warehouse/page/{orderCurrentPage}/{page}");
    }
}
