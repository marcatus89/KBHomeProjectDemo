@page "/admin/products/add"
@page "/admin/products/edit/{ProductId:int}"
@attribute [Authorize(Roles = "Admin")]
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject ToastService ToastSvc

<h3>@Title</h3>

@if (isLoading)
{
    <LoadingSpinner />
}
else
{
    <EditForm Model="@CurrentProduct" OnValidSubmit="HandleValidSubmit">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group mb-3">
            <label for="name">T√™n s·∫£n ph·∫©m</label>
            <InputText id="name" class="form-control" @bind-Value="CurrentProduct.Name" />
            <ValidationMessage For="@(() => CurrentProduct.Name)" />
        </div>

        <div class="form-group mb-3">
            <label for="price">Gi√°</label>
            <InputNumber id="price" class="form-control" @bind-Value="CurrentProduct.Price" />
        </div>

        <div class="form-group mb-3">
            <label for="imageUrl">URL H√¨nh ·∫£nh</label>
            <InputText id="imageUrl" class="form-control" @bind-Value="CurrentProduct.ImageUrl" />
        </div>

        <div class="form-group mb-3">
            <label for="category">Danh m·ª•c</label>
            <InputSelect id="category" class="form-select" @bind-Value="CurrentProduct.CategoryId">
                <option value="0">-- Ch·ªçn danh m·ª•c --</option>
                @if (categories != null)
                {
                    @foreach (var category in categories)
                    {
                        <option value="@category.Id">@category.Name</option>
                    }
                }
            </InputSelect>
            <ValidationMessage For="@(() => CurrentProduct.CategoryId)" />
        </div>

        <div class="form-group mb-3">
            <label for="description">M√¥ t·∫£ s·∫£n ph·∫©m</label>
            <InputTextArea id="description" class="form-control" @bind-Value="CurrentProduct.Description" rows="5" />
            <ValidationMessage For="@(() => CurrentProduct.Description)" />
            <small class="text-muted">T·ªëi ƒëa 2000 k√Ω t·ª±.</small>
        </div>

        <button type="submit" class="btn btn-primary">L∆∞u</button>
        <a href="/admin/products" class="btn btn-secondary">H·ªßy</a>
    </EditForm>
}

@code {
    [Parameter]
    public int ProductId { get; set; }

    private Product CurrentProduct { get; set; } = new();
    private List<Category>? categories;
    private string Title { get; set; } = "Th√™m s·∫£n ph·∫©m m·ªõi";
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        categories = await DbContext.Categories.ToListAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (ProductId != 0)
        {
            Title = "Ch·ªânh s·ª≠a s·∫£n ph·∫©m";
            var productFromDb = await DbContext.Products.FindAsync(ProductId);
            if (productFromDb != null)
            {
                CurrentProduct = productFromDb;
            }
        }
        else 
        {
            Title = "Th√™m s·∫£n ph·∫©m m·ªõi";
            CurrentProduct = new Product();
        }
        isLoading = false;
    }

    private async Task HandleValidSubmit()
    {
        // üîπ Chu·∫©n h√≥a t√™n s·∫£n ph·∫©m: b·ªè kho·∫£ng tr·∫Øng th·ª´a v√† ch·ªØ hoa/th∆∞·ªùng
        var normalizedName = NormalizeName(CurrentProduct.Name);

        if (string.IsNullOrWhiteSpace(normalizedName))
        {
            ToastSvc.ShowToast("‚ö†Ô∏è T√™n s·∫£n ph·∫©m kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.", ToastLevel.Warning);
            return;
        }

        // üîπ Ki·ªÉm tra tr√πng t√™n trong b·ªô nh·ªõ ƒë·ªÉ tr√°nh l·ªói LINQ translation
        var existingNames = await DbContext.Products
            .AsNoTracking()
            .Select(p => new { p.Id, p.Name })
            .ToListAsync();

        bool nameExists = existingNames
            .Any(p => NormalizeName(p.Name) == normalizedName && p.Id != ProductId);

        if (nameExists)
        {
            ToastSvc.ShowToast("‚ùå T√™n s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i (kh√¥ng ph√¢n bi·ªát hoa/th∆∞·ªùng ho·∫∑c kho·∫£ng tr·∫Øng).", ToastLevel.Error);
            return;
        }

        // ‚úÖ Th√™m ho·∫∑c c·∫≠p nh·∫≠t s·∫£n ph·∫©m
        if (ProductId == 0)
        {
            DbContext.Products.Add(CurrentProduct);
            ToastSvc.ShowToast($"‚úÖ ƒê√£ th√™m s·∫£n ph·∫©m \"{CurrentProduct.Name}\" th√†nh c√¥ng.", ToastLevel.Success);
        }
        else
        {
            var productToUpdate = await DbContext.Products.FindAsync(ProductId);
            if (productToUpdate != null)
            {
                productToUpdate.Name = CurrentProduct.Name;
                productToUpdate.Price = CurrentProduct.Price;
                productToUpdate.ImageUrl = CurrentProduct.ImageUrl;
                productToUpdate.CategoryId = CurrentProduct.CategoryId;
                productToUpdate.Description = CurrentProduct.Description; // <-- c·∫≠p nh·∫≠t m√¥ t·∫£
                ToastSvc.ShowToast($"‚úÖ ƒê√£ c·∫≠p nh·∫≠t s·∫£n ph·∫©m \"{productToUpdate.Name}\" th√†nh c√¥ng.", ToastLevel.Success);
            }
        }

        await DbContext.SaveChangesAsync();
        Navigation.NavigateTo("/admin/products");
    }

    // üßπ Chu·∫©n h√≥a t√™n: lo·∫°i b·ªè kho·∫£ng tr·∫Øng d∆∞ v√† chuy·ªÉn sang ch·ªØ th∆∞·ªùng
    private string NormalizeName(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return string.Empty;
        // X√≥a kho·∫£ng tr·∫Øng th·ª´a gi·ªØa c√°c t·ª´ v√† hai ƒë·∫ßu
        var cleaned = string.Join(" ", name.Split(' ', StringSplitOptions.RemoveEmptyEntries));
        return cleaned.Trim().ToLower();
    }
}
