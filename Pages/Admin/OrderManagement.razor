@page "/admin/orders"
@attribute [Authorize(Roles = "Admin, Sales, Warehouse, Logistics")]

@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using System.Linq
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject OrderService OrderSvc
@inject ToastService ToastSvc
@inject IJSRuntime JS

<h3>Quản lý Đơn hàng</h3>

<!-- THANH TÌM KIẾM -->
<div class="row mb-3">
    <div class="col-md-3">
        <input @bind="searchTerm" class="form-control" placeholder="Tìm ID / Tên KH / Trạng thái..." />
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary me-2" @onclick="SearchOrders">Tìm kiếm</button>
        <button class="btn btn-secondary" @onclick="ClearSearch">Xóa lọc</button>
    </div>
</div>

@if (pagedOrders == null)
{
    <LoadingSpinner />
}
else if (!pagedOrders.Any())
{
    <div class="alert alert-info mt-4">
        Không có đơn hàng nào phù hợp với vai trò của bạn ở thời điểm hiện tại.
    </div>
}
else
{
    <table class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th>ID Đơn hàng</th>
                <th>Tên Khách hàng</th>
                <th>Ngày Đặt</th>
                <th>Trạng thái</th>
                <th>Tổng tiền</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var order in pagedOrders)
            {
                <tr>
                    <td>@order.Id</td>
                    <td>@order.CustomerName</td>
                    <td>@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                    <td><span class="badge @GetStatusBadgeClass(order.Status)">@order.Status</span></td>
                    <td>@order.TotalAmount.ToString("n0") VNĐ</td>
                    <td>
                        <a href="@($"admin/orders/{order.Id}")" class="btn btn-sm btn-secondary me-1">Xem chi tiết</a>

                        @* Hiển thị nút Hủy cho Admin hoặc Sales, và nếu trạng thái cho phép *@
                        @if (CanCancel(order))
                        {
                            <button class="btn btn-sm btn-danger" @onclick="() => ConfirmCancel(order.Id)">Hủy</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <!-- PHÂN TRANG -->
    @if (totalPages > 1)
    {
        <nav>
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">Trước</button>
                </li>

                @for (int i = 1; i <= totalPages; i++)
                {
                    var pageNum = i;   @* capture biến cục bộ để tránh vấn đề closure *@
                    <li class="page-item @(pageNum == currentPage ? "active" : "")">
                        <button class="page-link" @onclick="() => ChangePage(pageNum)">@pageNum</button>
                    </li>
                }

                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">Sau</button>
                </li>
            </ul>
        </nav>
    }
}

@code {
    private List<Order>? allOrders;
    private IEnumerable<Order>? pagedOrders;

    private string? searchTerm;

    // Phân trang
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalPages = 1;

    // Current user (roles)
    private ClaimsPrincipal? currentUser;

    protected override async Task OnInitializedAsync()
    {
        // Lấy trạng thái xác thực, vai trò user
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUser = authState.User;
        await LoadOrders();
    }

    private async Task LoadOrders()
    {
        // Tạo DbContext riêng cho lần load này
        await using var db = await DbFactory.CreateDbContextAsync();

        IQueryable<Order> query = db.Orders.AsNoTracking();

        // Lọc theo vai trò (Admin thấy tất cả)
        if (currentUser == null || !currentUser.IsInRole("Admin"))
        {
            var allowedStatuses = new HashSet<string>();

            if (currentUser?.IsInRole("Sales") == true)
                allowedStatuses.Add("Chờ xác nhận");
            if (currentUser?.IsInRole("Warehouse") == true)
                allowedStatuses.Add("Đã thanh toán");
            if (currentUser?.IsInRole("Logistics") == true)
            {
                allowedStatuses.Add("Sẵn sàng giao hàng");
                allowedStatuses.Add("Đang giao");
            }

            if (allowedStatuses.Count > 0)
                query = query.Where(o => allowedStatuses.Contains(o.Status));
            else
                query = query.Where(o => false); // không cho thấy gì
        }

        // Tìm kiếm
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            var s = searchTerm.Trim();

            if (int.TryParse(s, out int idSearch))
            {
                query = query.Where(o =>
                    o.Id == idSearch ||
                    EF.Functions.Like(o.CustomerName, $"%{s}%") ||
                    EF.Functions.Like(o.Status, $"%{s}%"));
            }
            else
            {
                query = query.Where(o =>
                    EF.Functions.Like(o.CustomerName, $"%{s}%") ||
                    EF.Functions.Like(o.Status, $"%{s}%"));
            }
        }

        allOrders = await query
            .OrderByDescending(o => o.OrderDate)
            .ToListAsync();

        // Tính số trang
        totalPages = (int)Math.Ceiling((double)allOrders.Count / pageSize);
        if (totalPages == 0) totalPages = 1;

        currentPage = Math.Clamp(currentPage, 1, totalPages);

        // Chia trang
        pagedOrders = allOrders
            .Skip((currentPage - 1) * pageSize)
            .Take(pageSize)
            .ToList();
    }

    private async Task SearchOrders()
    {
        currentPage = 1;
        await LoadOrders();
    }

    private async Task ClearSearch()
    {
        searchTerm = null;
        currentPage = 1;
        await LoadOrders();
    }

    private async Task ChangePage(int page)
    {
        // clamp
        page = Math.Clamp(page, 1, totalPages);

        // nếu click vào trang hiện tại thì bỏ qua
        if (page == currentPage) return;

        currentPage = page;
        await LoadOrders();
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Hoàn thành" => "bg-success",
            "Đã hủy" => "bg-danger",
            "Đang giao" => "bg-primary",
            "Sẵn sàng giao hàng" => "bg-warning text-dark",
            "Đã thanh toán" => "bg-info text-dark",
            "Chờ xác nhận" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private bool CanCancel(Order order)
    {
        // Không cho hủy nếu đã hủy/đã giao/hoàn thành
        var forbidden = new[] { "Đã hủy", "Đã giao", "Hoàn thành" };
        if (forbidden.Contains(order.Status)) return false;

        // Cho phép hủy nếu user là Admin hoặc Sales
        if (currentUser?.IsInRole("Admin") == true) return true;
        if (currentUser?.IsInRole("Sales") == true) return true;

        return false;
    }

    private async Task ConfirmCancel(int orderId)
    {
        var ok = await JS.InvokeAsync<bool>("confirm", $"Bạn có chắc muốn hủy đơn #{orderId}?");
        if (!ok) return;

        // Debug: show quantities before cancel
        await using var dbDebug = await DbFactory.CreateDbContextAsync();
        var details = await dbDebug.OrderDetails.Where(d => d.OrderId == orderId).ToListAsync();
        foreach (var d in details)
        {
            var p = await dbDebug.Products.FindAsync(d.ProductId);
            Console.WriteLine($"BEFORE cancel: Product {d.ProductId} stock={p?.StockQuantity} will add {d.Quantity}");
        }

        var result = await OrderSvc.CancelOrderAsync(orderId, currentUser);
        if (result.Success)
        {
            ToastSvc.ShowToast($"Đã hủy đơn #{orderId} và trả hàng về kho.", ToastLevel.Success);

            // Debug: show quantities after cancel
            await using var dbDebug2 = await DbFactory.CreateDbContextAsync();
            foreach (var d in details)
            {
                var p2 = await dbDebug2.Products.FindAsync(d.ProductId);
                Console.WriteLine($"AFTER cancel: Product {d.ProductId} stock={p2?.StockQuantity}");
            }

            await LoadOrders();
        }
        else
        {
            ToastSvc.ShowToast(result.ErrorMessage, ToastLevel.Error);
        }
    }
}
