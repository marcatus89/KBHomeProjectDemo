@page "/admin/orders/{OrderId:int}"
@attribute [Authorize(Roles = "Admin, Sales,Warehouse, Logistics")]
@using Microsoft.EntityFrameworkCore
@using DoAnTotNghiep.Models
@using System.Security.Claims
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject ToastService ToastSvc
@inject AuthenticationStateProvider AuthStateProvider

<h3>Chi tiết Đơn hàng #@OrderId</h3>

@if (CurrentOrder == null)
{
    <LoadingSpinner />
}
else
{
    <div id="printable-area" class="printable-container mb-4">
        <div class="invoice-header d-flex align-items-center mb-4">
            <img src="/images/logo.png" class="invoice-logo me-4" alt="Company Logo" />
            <div class="company-details">
                <strong>Công ty TNHH KBHOME VIETNAM</strong><br />
                Showroom HCM 46 Song Hành, Phường Bình Trưng, Thành Phố Hồ Chí Minh.<br />
                Hotline: +84 93 189 48 68
            </div>
        </div>

        <h2 class="text-center mt-4">BIÊN BẢN GIAO NHẬN HÀNG HÓA</h2>
        <p class="text-center">Số Đơn hàng: #@CurrentOrder.Id</p>
        <hr />
        <p><strong>Khách hàng:</strong> @CurrentOrder.CustomerName</p>
        <p><strong>Địa chỉ giao hàng:</strong> @CurrentOrder.ShippingAddress</p>
        <p><strong>Số điện thoại:</strong> @CurrentOrder.PhoneNumber</p>
        <p><strong>Ngày giao hàng:</strong> @DateTime.Now.ToString("dd/MM/yyyy")</p>

        <table class="table table-bordered mt-4">
            <thead>
                <tr>
                    <th>STT</th>
                    <th>Tên Sản phẩm</th>
                    <th>Số lượng</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int count = 1;
                }
                @foreach (var detail in CurrentOrder.OrderDetails)
                {
                    <tr>
                        <td>@(count++)</td>
                        <td>@detail.ProductName</td>
                        <td>@detail.Quantity</td>
                    </tr>
                }
            </tbody>
        </table>

        <div class="signature-section mt-4 d-flex justify-content-between">
            <div class="signature-box text-center">
                <p><strong>Bên Giao</strong></p>
                <p>(Ký, họ tên)</p>
            </div>
            <div class="signature-box text-center">
                <p><strong>Bên Nhận</strong></p>
                <p>(Ký, họ tên)</p>
            </div>
        </div>

        <p class="mt-4"><i>Xác nhận đã nhận đủ số lượng, đúng quy cách, chất lượng hàng hóa.</i></p>
    </div>

    <div id="display-area" class="row">
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <strong>Đơn hàng #@CurrentOrder.Id | Trạng thái:
                        <span class="badge @GetStatusBadgeClass(CurrentOrder.Status)">@CurrentOrder.Status</span>
                    </strong>

                    <AuthorizeView Roles="Admin, Logistics">
                        <button class="btn btn-outline-secondary btn-sm" @onclick="Print">
                            <span class="oi oi-print"></span> In Biên bản
                        </button>
                    </AuthorizeView>
                </div>

                <div class="card-body">
                    <h4>Thông tin Khách hàng</h4>
                    <p><strong>Tên:</strong> @CurrentOrder.CustomerName</p>
                    <p><strong>Địa chỉ:</strong> @CurrentOrder.ShippingAddress</p>
                    <p><strong>Số điện thoại:</strong> @CurrentOrder.PhoneNumber</p>

                    @if (!string.IsNullOrWhiteSpace(CurrentOrder.SalesNotes))
                    {
                        <hr />
                        <h5>Ghi chú Sales</h5>
                        <p class="text-muted">@CurrentOrder.SalesNotes</p>
                    }

                    @if (CurrentOrder.Shipment != null)
                    {
                        <hr />
                        <h5>Thông tin Giao hàng</h5>
                        <p><strong>ĐV Vận chuyển:</strong> @CurrentOrder.Shipment.ShippingProvider</p>
                        <p><strong>Mã vận đơn:</strong> @CurrentOrder.Shipment.TrackingNumber</p>

                        <p><strong>Ngày giao:</strong> @GetDeliveredDateText(CurrentOrder.Shipment)</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">Hành động</div>
                <div class="card-body">
                    <AuthorizeView Roles="Admin">
                        <div class="mb-2">
                            <label>Cập nhật trạng thái (Admin):</label>
                            <InputSelect class="form-select" @bind-Value="newStatus">
                                <option value="Chờ xác nhận">Chờ xác nhận</option>
                                <option value="Chờ thanh toán">Chờ thanh toán</option>
                                <option value="Đã thanh toán">Đã thanh toán</option>
                                <option value="Sẵn sàng giao hàng">Sẵn sàng giao hàng</option>
                                <option value="Đang giao">Đang giao</option>
                                <option value="Hoàn thành">Hoàn thành</option>
                                <option value="Đã hủy">Đã hủy</option>
                            </InputSelect>
                        </div>
                        <button class="btn btn-primary w-100" @onclick="UpdateStatus">Cập nhật</button>
                    </AuthorizeView>

                    <AuthorizeView Roles="Sales">
                        @if (CurrentOrder.Status == "Chờ xác nhận")
                        {
                            <div class="mb-2">
                                <label><strong>Ghi chú Sales:</strong></label>
                                <InputTextArea @bind-Value="salesNoteInput" class="form-control" rows="3" />
                            </div>
                            <div class="d-grid gap-2">
                                <button class="btn btn-success" @onclick='async () => { newStatus = "Chờ thanh toán"; await UpdateStatus(); }'>Xác nhận đơn</button>
                                <button class="btn btn-danger" @onclick='async () => { newStatus = "Đã hủy"; await UpdateStatus(); }'>Hủy đơn</button>
                            </div>
                        }
                    </AuthorizeView>

                    <AuthorizeView Roles="Warehouse">
                        @if (CurrentOrder.Status == "Đã thanh toán")
                        {
                            <button class="btn btn-info w-100" @onclick='async () => { newStatus = "Sẵn sàng giao hàng"; await UpdateStatus(); }'>Xác nhận đã chuẩn bị hàng</button>
                        }
                    </AuthorizeView>

                    <AuthorizeView Roles="Logistics">
                        @if (CurrentOrder.Status == "Đang giao")
                        {
                            <button class="btn btn-success w-100" @onclick='async () => { newStatus = "Hoàn thành"; await UpdateStatus(); }'>Xác nhận đã giao thành công</button>
                        }
                    </AuthorizeView>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public int OrderId { get; set; }

    private Order? CurrentOrder;
    private string newStatus = string.Empty;
    private string? salesNoteInput;

    // thứ tự trạng thái để kiểm tra "lùi trạng thái"
    private readonly List<string> _statusOrder = new()
    {
        "Chờ xác nhận",
        "Chờ thanh toán",
        "Đã thanh toán",
        "Sẵn sàng giao hàng",
        "Đang giao",
        "Hoàn thành"
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadCurrentOrderAsync();
    }

    private async Task LoadCurrentOrderAsync()
    {
        await using var db = await DbFactory.CreateDbContextAsync();
        CurrentOrder = await db.Orders
                                .Include(o => o.Shipment)
                                .Include(o => o.OrderDetails)
                                .FirstOrDefaultAsync(o => o.Id == OrderId);

        if (CurrentOrder != null)
        {
            newStatus = CurrentOrder.Status ?? string.Empty;
            salesNoteInput = CurrentOrder.SalesNotes;
        }
    }

    private bool IsTerminalOrFinal(string status)
    {
        return string.Equals(status, "Hoàn thành", StringComparison.OrdinalIgnoreCase)
               || string.Equals(status, "Đã hủy", StringComparison.OrdinalIgnoreCase);
    }

    private bool IsValidTransition(string oldStatus, string newStatus)
    {
        if (string.Equals(oldStatus, newStatus, StringComparison.OrdinalIgnoreCase))
            return true;

        if (IsTerminalOrFinal(oldStatus))
            return false;

        if (string.Equals(newStatus, "Đã hủy", StringComparison.OrdinalIgnoreCase))
        {
            if (string.Equals(oldStatus, "Hoàn thành", StringComparison.OrdinalIgnoreCase)
                || string.Equals(oldStatus, "Đã hủy", StringComparison.OrdinalIgnoreCase))
                return false;
            return true;
        }

        var oldIndex = _statusOrder.IndexOf(oldStatus);
        var newIndex = _statusOrder.IndexOf(newStatus);
        if (oldIndex < 0 || newIndex < 0)
        {
            return false;
        }
        return newIndex >= oldIndex;
    }

    private async Task UpdateStatus()
    {
        if (CurrentOrder == null || string.IsNullOrEmpty(newStatus))
            return;

        var oldStatus = CurrentOrder.Status ?? string.Empty;
        if (!IsValidTransition(oldStatus, newStatus))
        {
            ToastSvc.ShowToast("Không thể lùi hoặc thay đổi trạng thái theo hướng không hợp lệ.", ToastLevel.Warning);
            return;
        }

        if (string.Equals(oldStatus, newStatus, StringComparison.OrdinalIgnoreCase))
        {
            ToastSvc.ShowToast("Trạng thái không thay đổi.", ToastLevel.Info);
            return;
        }

        // Thực thi trong context mới và transaction
        await using var db = await DbFactory.CreateDbContextAsync();
        await using var tx = await db.Database.BeginTransactionAsync();
        try
        {
            var order = await db.Orders
                                .Include(o => o.OrderDetails)
                                .Include(o => o.Shipment)
                                .FirstOrDefaultAsync(o => o.Id == OrderId);

            if (order == null)
            {
                ToastSvc.ShowToast("Không tìm thấy đơn hàng.", ToastLevel.Error);
                await tx.RollbackAsync();
                return;
            }

            if (!IsValidTransition(order.Status ?? string.Empty, newStatus))
            {
                ToastSvc.ShowToast("Chuyển trạng thái không hợp lệ (sau khi kiểm tra lại).", ToastLevel.Warning);
                await tx.RollbackAsync();
                return;
            }

            // Nếu hủy — trả tồn và ghi InventoryLog có OldQuantity
            if (string.Equals(newStatus, "Đã hủy", StringComparison.OrdinalIgnoreCase)
                && !string.Equals(order.Status, "Đã hủy", StringComparison.OrdinalIgnoreCase))
            {
                var auth = await AuthStateProvider.GetAuthenticationStateAsync();
                var user = auth.User;
                var who = user?.Identity?.IsAuthenticated == true ? (user.Identity?.Name ?? "Unknown") : "Hệ thống";

                foreach (var detail in order.OrderDetails)
                {
                    var product = await db.Products.FirstOrDefaultAsync(p => p.Id == detail.ProductId);
                    if (product == null) continue;

                    int oldQty = product.StockQuantity;
                    product.StockQuantity += detail.Quantity;
                    db.Products.Update(product);

                    // thêm inventory log (OldQuantity + QuantityChange + NewQuantity)
                    var log = new InventoryLog
                    {
                        ProductId = product.Id,
                        OldQuantity = oldQty,
                        QuantityChange = detail.Quantity,
                        NewQuantity = product.StockQuantity,
                        Reason = $"Trả hàng do hủy đơn #{order.Id} (hủy bởi {who})",
                        Timestamp = DateTime.UtcNow
                    };
                    await db.InventoryLogs.AddAsync(log);
                }
            }

            // cập nhật trạng thái và sales notes
            order.Status = newStatus;
            if (!string.IsNullOrWhiteSpace(salesNoteInput))
                order.SalesNotes = salesNoteInput;

            // Nếu hoàn thành -> set DeliveredDate trên shipment nếu có
            if (string.Equals(newStatus, "Hoàn thành", StringComparison.OrdinalIgnoreCase) && order.Shipment != null)
            {
                var shipment = await db.Shipments.FirstOrDefaultAsync(s => s.Id == order.Shipment.Id);
                if (shipment != null)
                {
                    var prop = shipment.GetType().GetProperty("DeliveredDate");
                    if (prop != null && prop.PropertyType == typeof(DateTime?))
                    {
                        prop.SetValue(shipment, DateTime.UtcNow);
                        db.Shipments.Update(shipment);
                    }
                }
            }

            db.Orders.Update(order);
            await db.SaveChangesAsync();
            await tx.CommitAsync();

            ToastSvc.ShowToast("Cập nhật trạng thái thành công.", ToastLevel.Success);

            // Reload order để UI cập nhật liền (sử dụng context mới)
            await LoadCurrentOrderAsync();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            try { await tx.RollbackAsync(); } catch { }
            Console.WriteLine("[OrderDetails] UpdateStatus exception: " + ex);
            ToastSvc.ShowToast("Có lỗi khi cập nhật trạng thái. Vui lòng thử lại.", ToastLevel.Error);
        }
    }

    private string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Hoàn thành" => "bg-success",
            "Đã hủy" => "bg-danger",
            "Đang giao" => "bg-primary",
            "Sẵn sàng giao hàng" => "bg-warning text-dark",
            "Chờ thanh toán" => "bg-info text-dark",
            _ => "bg-secondary"
        };
    }

    private async Task Print()
    {
        await JSRuntime.InvokeVoidAsync("triggerPrint");
    }

    // Helper để lấy nội dung ngày giao an toàn
    private string GetDeliveredDateText(Shipment? shipment)
    {
        if (shipment == null) return "(chưa giao)";
        var prop = shipment.GetType().GetProperty("DeliveredDate");
        if (prop != null)
        {
            var val = prop.GetValue(shipment);
            if (val is DateTime dt) return dt.ToLocalTime().ToString("g");
            if (val is DateTime?) { var ndt = (DateTime?)val; if (ndt.HasValue) return ndt.Value.ToLocalTime().ToString("g"); }
        }
        return "(chưa giao)";
    }
}
